<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Worker Schedule | Single-file App</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%23705c49'/%3E%3Ctext x='50%25' y='50%25' dy='.35em' text-anchor='middle' font-family='Segoe UI, Arial' font-size='32' fill='%23ffffff'%3ES%3C/text%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #faf8f4;
      --surface: #fffdf8;
      --text: #2a2a2a;
      --muted-text: #4a4a4a;
      --border: #e5ded2;
      --header-bg: #705c49;
      --header-text: #ffffff;
      --accent: #b88a51;
      --accent-2: #7d9a6d;
      --danger: #ab4e4e;
      --focus: #2b7bbb;
      --chip-bg: #efe7dc;

      --day-header-bg: #eae3d9;
      --legend-bg: #f2ebe0;
      --grid-bg: #fffdf8;
      --slot-h: 28px;
      --corner-r: 10px;
      --grid-line: 2px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100dvh;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--header-bg);
      color: var(--header-text);
      border-bottom: 1px solid #5f4f3f;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-title {
      font-weight: 700;
      letter-spacing: 0.06em;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button.icon-btn, .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.1);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    button.icon-btn:hover, .btn:hover { background: rgba(255,255,255,0.16); }
    button.danger { background: rgba(255, 90, 90, 0.16); border-color: rgba(255, 90, 90, 0.4); }
    button.primary { background: rgba(255,255,255,0.25); }

    .app-main {
      padding: 16px;
      display: grid;
      gap: 16px;
    }

    .schedule-shell {
      display: grid;
      grid-template-columns: minmax(60px, 80px) 1fr minmax(60px, 80px);
      gap: 8px;
      align-items: end; /* Align gutters and day blocks at the bottom */
      max-height: calc(100dvh - 140px);
      overflow: auto;
    }

    .time-gutter, .time-gutter-right {
      background: var(--surface);
      border: var(--grid-line) solid var(--border);
      border-bottom: 0; /* remove bottom border, will add synthetic one */
      border-radius: var(--corner-r);
      padding: 0; /* Remove padding to align with day blocks */
      position: sticky;
      left: 0;
      right: 0;
      top: auto;
      max-height: none;
      overflow: visible;
      display: grid;
      grid-template-rows: repeat(18, var(--slot-h)); /* 2 spacers + 16 time slots */
      grid-auto-rows: var(--slot-h);
      align-content: start;
      gap: 0;
      margin-top: 0;
      position: relative;
    }

    /* Add bottom border to last time row instead of synthetic border */
    .time-gutter .time:last-child, .time-gutter-right .time:last-child {
      border-bottom: var(--grid-line) solid var(--border);
      border-bottom-left-radius: var(--corner-r);
      border-bottom-right-radius: var(--corner-r);
    }

    .time-gutter .time, .time-gutter-right .time {
      font-size: 12px;
      color: var(--muted-text);
      display: flex;
      align-items: center;
      justify-content: center;
      height: var(--slot-h);
    }

    /* Draw dividers per item so we can skip the last one and avoid double bottom border */
    .time-gutter, .time-gutter-right { background-image: none; }
    /* Match day grid: two header/legend spacers, then 16 time rows */
    .time-gutter .time, .time-gutter-right .time { box-sizing: border-box; border-top: var(--grid-line) solid var(--border); border-bottom: 0; }
    /* Last row keeps full height since synthetic bottom stroke handles alignment */
    .time-gutter .time:nth-child(1), .time-gutter .time:nth-child(2),
    .time-gutter-right .time:nth-child(1), .time-gutter-right .time:nth-child(2) { border-top: 0; }

    .week-grid {
      background: var(--grid-bg);
      border-radius: var(--corner-r);
      padding: 0; /* Remove padding to align with gutters */
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 4px;
      overflow: visible;
      min-width: 0;
      max-height: none;
    }

    .day-block {
      display: grid;
      grid-template-rows: var(--slot-h) var(--slot-h) auto;
      border: var(--grid-line) solid var(--border);
      border-radius: var(--corner-r);
      overflow: hidden;
      background: var(--surface);
    }

    .day-header {
      background: var(--day-header-bg);
      padding: 0 10px;
      font-weight: 600;
      border-bottom: var(--grid-line) solid var(--border);
      letter-spacing: 0.03em;
      height: var(--slot-h);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .legend-row {
      background: var(--legend-bg);
      padding: 0;
      border-bottom: 0;
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(20px, 1fr);
      gap: 0;
      height: var(--slot-h);
      align-items: center;
    }
    .legend-chip {
      background: var(--chip-bg);
      color: var(--text);
      font-weight: 600;
      font-size: 11px;
      border-radius: 6px;
      padding: 2px 4px;
      text-align: center;
      border: var(--grid-line) solid var(--border);
    }
    /* Align legend cell borders with slot cell borders (avoid double-left borders) */
    .legend-row .legend-chip { border-left: none; }
    .legend-row .legend-chip:first-child { border-left: 1px solid var(--border); }

    .schedule-rows {
      padding: 0;
      display: grid;
      grid-template-rows: repeat(16, var(--slot-h));
      gap: 0;
    }
    .slot-row { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(20px, 1fr); gap: 0; align-items: stretch; }
    /* Single-line grid borders: draw only top and right borders per cell */
    .slot-cell { border: 0; border-top: var(--grid-line) solid var(--border); border-right: var(--grid-line) solid var(--border); background: #fff; cursor: pointer; }
    /* Avoid double-thick edges: no right border on last col, no bottom border on last row */
    .slot-row .slot-cell:last-child { border-right: none; }
    .schedule-rows .slot-row:last-child .slot-cell { border-bottom: none; }
    /* First data row draws its own top border; legend has no bottom border now */
    .schedule-rows .slot-row:first-child .slot-cell { border-top: var(--grid-line) solid var(--border); }
    /* Use inset box-shadow for focus so it respects corner radii and avoids clipping */
    .slot-cell:focus { outline: none; box-shadow: inset 0 0 0 2px var(--focus); position: relative; z-index: 2; }
    /* Hover triangulation: highlight current row and column */
    .slot-row.is-hover { background: rgba(0,0,0,0.035); }
    /* Hover ring also uses inset shadow to respect rounded corners */
    .slot-cell.col-hover { box-shadow: inset 0 0 0 2px var(--focus); position: relative; z-index: 2; }
    /* Round the bottom corner cells to match day-block radius so inner borders don't bite into curves */
    .schedule-rows .slot-row:last-child .slot-cell:first-child { border-bottom-left-radius: var(--corner-r); }
    .schedule-rows .slot-row:last-child .slot-cell:last-child { border-bottom-right-radius: var(--corner-r); }
    .time.is-hover { background: rgba(0,0,0,0.06); font-weight: 600; }
    .legend-chip.is-hover { outline: 2px solid var(--focus); outline-offset: -2px; position: relative; z-index: 2; }

    /* Paint indicator */
    .paint-indicator { position: fixed; pointer-events: none; z-index: 100; background: rgba(0,0,0,0.75); color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 12px; transform: translate(12px, -12px); }

    .totals-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }
    .totals-title { font-weight: 700; margin-bottom: 8px; }
    table#totalsTable { width: 100%; border-collapse: collapse; }
    table#totalsTable th, table#totalsTable td { border: 1px solid var(--border); padding: 8px 10px; font-size: 14px; }
    table#totalsTable th { background: var(--legend-bg); text-align: left; }

    .app-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      font-size: 12px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      color: var(--muted-text);
    }
    .badges { display: flex; gap: 8px; align-items: center; }
    .badge { background: var(--legend-bg); border: 1px solid var(--border); padding: 4px 8px; border-radius: 999px; }

    /* Tests panel */
    .tests-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    .tests-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .tests-title { font-weight: 700; }
    #testResults { background: #111; color: #e6e6e6; padding: 10px; border-radius: 8px; max-height: 240px; overflow: auto; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal { width: min(520px, 92vw); background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .modal input:focus, .modal select:focus { position: relative; z-index: 1; outline: none; box-shadow: inset 0 0 0 2px var(--focus); }
    .modal h3 { margin: 0 0 10px 0; }
    .modal .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal .row > * { min-width: 0; }
    .modal label { font-size: 12px; color: var(--muted-text); }
    .modal input, .modal select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: #fff; box-sizing: border-box; }
    @media (max-width: 520px) { .modal .row { grid-template-columns: 1fr; } }
    .modal .actions { margin-top: 12px; display: flex; gap: 8px; justify-content: flex-end; }

    /* Student color chips (deterministic palette) */
    .swatch-0 { background: #D8C3A5; }
    .swatch-1 { background: #E9D8A6; }
    .swatch-2 { background: #CDE5D7; }
    .swatch-3 { background: #F1D6C1; }
    .swatch-4 { background: #BFD7EA; }

    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <header class="app-header" role="banner">
      <div class="header-title" id="headerTitle" aria-live="polite">STUDENT WORKER SCHEDULE | 2024–2025</div>
      <div class="header-actions" role="toolbar" aria-label="Schedule actions">
        <button class="icon-btn" id="btnSave" title="Quick Save (Ctrl+S)">Save</button>
        <button class="icon-btn danger" id="btnClear" title="Clear all times">Clear Times</button>
        <button class="icon-btn primary" id="btnPDF" title="Export PDF (Alt+P)">PDF</button>
        <button class="icon-btn" id="btnDownload" title="Download single-file HTML">Download</button>
        <button class="icon-btn" id="btnAddStudent" title="Add a student">Add Student</button>
        <button class="icon-btn" id="btnTests" title="Show MiniTest panel">Tests</button>
      </div>
    </header>

    <main class="app-main" role="main">
      <section class="schedule-shell" aria-label="Schedule grid area">
        <aside class="time-gutter" aria-label="Time gutter left" id="leftGutter"></aside>
        <div class="week-grid" id="weekGrid" role="grid" aria-label="Week grid">
          <!-- Day blocks will be rendered here -->
        </div>
        <aside class="time-gutter-right" aria-label="Time gutter right" id="rightGutter"></aside>
      </section>

      <section class="totals-section" id="totalsSection" aria-label="Hours summary">
        <div class="totals-title">Weekly Hours Summary</div>
        <table id="totalsTable" aria-describedby="totalsHelp">
          <thead>
            <tr>
              <th>Student</th>
              <th>Mon</th>
              <th>Tue</th>
              <th>Wed</th>
              <th>Thu</th>
              <th>Fri</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7" style="text-align:center;color:var(--muted-text)">Totals will appear after grid is implemented</td></tr>
          </tbody>
        </table>
        <div id="totalsHelp" class="visually-hidden">Shows per-student daily and weekly hours.</div>
      </section>

      <section class="tests-panel" id="testsPanel" aria-label="MiniTest" style="display:none">
        <div class="tests-header">
          <div class="tests-title">MiniTest</div>
          <div class="tests-actions">
            <button class="btn" id="btnRunTests">Run Tests</button>
          </div>
        </div>
        <pre id="testResults" aria-live="polite">(no results yet)</pre>
      </section>
    </main>

    <footer class="app-footer" role="contentinfo">
      <div>Single-file app v1.0.0</div>
      <div class="badges">
        <div class="badge">Earth-tone Theme</div>
        <div class="badge">Embedded Data</div>
        <div class="badge">PDF Ready</div>
      </div>
    </footer>
  </div>

  <!-- Modal: Add/Edit Student -->
  <div class="modal-overlay" id="studentModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="studentModalTitle">
      <h3 id="studentModalTitle">Add Student</h3>
      <div class="row">
        <div>
          <label for="studentName">Full name</label>
          <input type="text" id="studentName" placeholder="e.g., Jane Doe" />
        </div>
        <div>
          <label for="studentRole">Role</label>
          <select id="studentRole">
            <option value="PA">PA</option>
            <option value="WS">WS</option>
            <option value="GA">GA</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="studentCancel">Cancel</button>
        <button class="btn primary" id="studentSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Embedded data bootstrap -->
  <script id="embedded-data" type="application/json">
  {
    "version": "1.0.0",
    "metadata": {"createdAt": "${new Date().toISOString()}", "source": "embedded"},
    "settings": { "headerTitle": "STUDENT WORKER SCHEDULE | 2024–2025" },
    "students": [
      {"id":"stu-1","name":"Jane Doe","code":"JD","role":"PA","colorIndex":0},
      {"id":"stu-2","name":"John Doe","code":"JDo","role":"WS","colorIndex":1},
      {"id":"stu-3","name":"Alex Kim","code":"AK","role":"GA","colorIndex":2},
      {"id":"stu-4","name":"Sam Lee","code":"SL","role":"PA","colorIndex":3},
      {"id":"stu-5","name":"Casey Ray","code":"CR","role":"WS","colorIndex":4}
    ],
    "schedule": {}
  }
  </script>

  <!-- Libraries (UMD) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    (function() {
      const APP_VERSION = '1.0.0';
      const STORAGE_KEYS = {
        hybrid: 'labSchedule',
        legacySchedule: 'studentWorkerSchedule',
        legacyPeople: 'studentWorkerPeople',
        appState: 'studentScheduleAppState'
      };
      

      const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
      const SLOT_LABELS = [
        '8:30–9:00','9:00–9:30','9:30–10:00','10:00–10:30','10:30–11:00','11:00–11:30','11:30–12:00','12:00–12:30',
        '12:30–1:00','1:00–1:30','1:30–2:00','2:00–2:30','2:30–3:00','3:00–3:30','3:30–4:00','4:00–4:30'
      ];

      function parseJSONSafe(text) {
        try { return JSON.parse(text); } catch { return null; }
      }

      const DataManager = {
        state: null,
        // Compute totals for UI and PDF in one place (Context7-style shared helper)
        computeTotals(state) {
          const students = (state && state.students) || [];
          const schedule = (state && state.schedule) || {};
          const makeKey = (di, si, sid) => `${di}|${si}|${sid}`;
          const perStudent = [];
          const dailyTotals = [0,0,0,0,0];
          let grand = 0;
          for (let s of students) {
            const row = { name: `${s.name}${s.role ? ' ' + s.role : ''}`.trim(), days: [0,0,0,0,0], total: 0 };
            for (let di = 0; di < 5; di++) {
              let day = 0;
              for (let si = 0; si < 16; si++) {
                if (schedule[makeKey(di, si, s.id)]) day += 0.5;
              }
              row.days[di] = day;
              row.total += day;
              dailyTotals[di] += day;
            }
            perStudent.push(row);
            grand += row.total;
          }
          return { perStudent, dailyTotals, grand };
        },
        getEmbedded() {
          const el = document.getElementById('embedded-data');
          if (!el) return null;
          const text = el.textContent && el.textContent.trim();
          if (!text) return null;
          return parseJSONSafe(text);
        },
        migrateLegacy(legacySchedule, legacyPeople) {
          // Minimal converter from legacy keys into new schema
          const students = Array.isArray(legacyPeople) ? legacyPeople.map((p, idx) => ({
            id: p.id || `legacy-${idx+1}`,
            name: p.name || p.fullName || `Student ${idx+1}`,
            code: p.code || (p.name ? p.name.split(' ').map(s=>s[0]).join('').slice(0,3).toUpperCase() : `S${idx+1}`),
            role: p.role || 'WS',
            colorIndex: idx % 5
          })) : [];
          return {
            version: APP_VERSION,
            metadata: { createdAt: new Date().toISOString(), source: 'legacy-migration' },
            settings: { headerTitle: 'STUDENT WORKER SCHEDULE | 2024–2025' },
            students,
            schedule: legacySchedule && typeof legacySchedule === 'object' ? legacySchedule : {}
          };
        },
        defaults() {
          // Mirror embedded defaults if present
          return this.getEmbedded() || {
            version: APP_VERSION,
            metadata: { createdAt: new Date().toISOString(), source: 'defaults' },
            settings: { headerTitle: 'STUDENT WORKER SCHEDULE | 2024–2025' },
            students: [
              {id:'stu-1',name:'Jane Doe',code:'JD',role:'PA',colorIndex:0},
              {id:'stu-2',name:'John Doe',code:'JDo',role:'WS',colorIndex:1},
              {id:'stu-3',name:'Alex Kim',code:'AK',role:'GA',colorIndex:2},
              {id:'stu-4',name:'Sam Lee',code:'SL',role:'PA',colorIndex:3},
              {id:'stu-5',name:'Casey Ray',code:'CR',role:'WS',colorIndex:4}
            ],
            schedule: {}
          };
        },
        load() {
          // 1) Embedded JSON
          const embedded = this.getEmbedded();
          if (embedded && typeof embedded === 'object') {
            this.state = embedded;
            return this.state;
          }
          // 2) Hybrid/localStorage legacy
          const hybrid = parseJSONSafe(localStorage.getItem(STORAGE_KEYS.hybrid));
          if (hybrid && hybrid.trackedState) {
            this.state = {
              version: APP_VERSION,
              metadata: { createdAt: new Date().toISOString(), source: 'hybrid-localStorage' },
              settings: { headerTitle: 'STUDENT WORKER SCHEDULE | 2024–2025' },
              students: Array.isArray(hybrid.students) ? hybrid.students : [],
              schedule: hybrid.trackedState || {}
            };
            return this.state;
          }
          const legacySchedule = parseJSONSafe(localStorage.getItem(STORAGE_KEYS.legacySchedule));
          const legacyPeople = parseJSONSafe(localStorage.getItem(STORAGE_KEYS.legacyPeople));
          if (legacySchedule || legacyPeople) {
            this.state = this.migrateLegacy(legacySchedule, legacyPeople);
            return this.state;
          }
          // 3) App state cache
          const appState = parseJSONSafe(localStorage.getItem(STORAGE_KEYS.appState));
          if (appState && typeof appState === 'object') {
            this.state = appState;
            return this.state;
          }
          // 4) Defaults
          this.state = this.defaults();
          return this.state;
        },
        save() {
          if (!this.state) return;
          try {
            localStorage.setItem(STORAGE_KEYS.appState, JSON.stringify(this.state));
          } catch (e) {
            console.warn('Save failed', e);
          }
        }
      };

      const UI = {
        init() {
          // Render header
          const title = DataManager.state?.settings?.headerTitle || 'STUDENT WORKER SCHEDULE | 2024–2025';
          document.getElementById('headerTitle').textContent = title;

          // Render gutters
          this.renderGutters();
          // Render interactive week grid and totals
          this.renderWeek(DataManager.state?.students || []);
          this.renderTotals();

          // Wire actions
          document.getElementById('btnSave').addEventListener('click', window.saveSchedule);
          document.getElementById('btnClear').addEventListener('click', window.clearTimes);
          document.getElementById('btnPDF').addEventListener('click', window.exportToPDF);
          document.getElementById('btnDownload').addEventListener('click', window.exportSchedule);
          document.getElementById('btnAddStudent').addEventListener('click', () => this.openStudentModal());
          document.getElementById('btnTests').addEventListener('click', () => {
            const p = document.getElementById('testsPanel');
            const opening = p.style.display === 'none';
            p.style.display = opening ? 'block' : 'none';
            if (opening) {
              const pre = document.getElementById('testResults');
              const isEmpty = pre && pre.textContent && pre.textContent.trim() === '(no results yet)';
              if (isEmpty && window.__Tests && typeof window.__Tests.runAll === 'function') {
                setTimeout(() => window.__Tests.runAll(), 0);
              }
            }
          });
          document.getElementById('btnRunTests').addEventListener('click', () => {
            if (window.__Tests && typeof window.__Tests.runAll === 'function') {
              window.__Tests.runAll();
            } else {
              alert('Tests not loaded yet. Try again in a moment.');
            }
          });

          document.getElementById('studentCancel').addEventListener('click', () => this.closeStudentModal());
          document.getElementById('studentSave').addEventListener('click', window.addStudentFromModal);

          // Close modal on overlay click
          document.getElementById('studentModal').addEventListener('click', (e) => {
            if (e.target && e.target.id === 'studentModal') this.closeStudentModal();
          });
          // Close modal on Escape
          window.addEventListener('keydown', (e) => {
            const modal = document.getElementById('studentModal');
            if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
              e.preventDefault();
              this.closeStudentModal();
            }
          });

          // Keyboard shortcut Alt+P → PDF
          window.addEventListener('keydown', (e) => {
            if (e.altKey && (e.key === 'p' || e.key === 'P')) {
              e.preventDefault();
              window.exportToPDF();
            }
          });
        },
        renderGutters() {
          const left = document.getElementById('leftGutter');
          const right = document.getElementById('rightGutter');
          left.innerHTML = '';
          right.innerHTML = '';
          // Add two spacer rows (header + legend)
          for (let i = 0; i < 2; i++) {
            const a = document.createElement('div'); a.className = 'time'; a.textContent = '';
            const b = document.createElement('div'); b.className = 'time'; b.textContent = '';
            left.appendChild(a); right.appendChild(b);
          }
          // 16 time rows matching slot rows
          SLOT_LABELS.forEach(lbl => {
            const a = document.createElement('div');
            a.className = 'time';
            a.textContent = lbl.replace('–','-');
            left.appendChild(a);
            const b = document.createElement('div');
            b.className = 'time';
            b.textContent = lbl.replace('–','-');
            right.appendChild(b);
          });
        },
        // Compute and render totals table from state
        renderTotals() {
          const tbody = document.querySelector('#totalsTable tbody');
          if (!tbody) return;
          const { perStudent, dailyTotals, grand } = DataManager.computeTotals(DataManager.state);
          tbody.innerHTML = '';
          // Per-student rows
          perStudent.forEach((row) => {
            const tr = document.createElement('tr');
            const nameCell = document.createElement('td');
            nameCell.textContent = row.name;
            tr.appendChild(nameCell);
            for (let di = 0; di < 5; di++) {
              const td = document.createElement('td');
              td.textContent = row.days[di].toFixed(2);
              tr.appendChild(td);
            }
            const totalTd = document.createElement('td');
            totalTd.textContent = row.total.toFixed(2);
            tr.appendChild(totalTd);
            tbody.appendChild(tr);
          });
          // Daily totals row
          const totalRow = document.createElement('tr');
          totalRow.style.fontWeight = '700';
          const labelTd = document.createElement('td');
          labelTd.textContent = 'DAILY TOTALS';
          totalRow.appendChild(labelTd);
          for (let di = 0; di < 5; di++) {
            const td = document.createElement('td');
            td.textContent = dailyTotals[di].toFixed(2);
            totalRow.appendChild(td);
          }
          const grandTd = document.createElement('td');
          grandTd.textContent = grand.toFixed(2);
          totalRow.appendChild(grandTd);
          tbody.appendChild(totalRow);
        },
        // Render full interactive week grid from state
        renderWeek(students) {
          const root = document.getElementById('weekGrid');
          root.innerHTML = '';
          // Ensure ARIA role for grid container
          root.setAttribute('role', 'grid');
          const leftGutter = document.getElementById('leftGutter');
          const rightGutter = document.getElementById('rightGutter');
          // Ensure paint indicator exists
          let indicator = document.getElementById('paintIndicator');
          if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'paintIndicator';
            indicator.className = 'paint-indicator';
            indicator.style.display = 'none';
            document.body.appendChild(indicator);
          }
          const schedule = (DataManager.state && DataManager.state.schedule) || {};
          const makeKey = (di, si, sid) => `${di}|${si}|${sid}`;
          // Roving tabindex: only one cell should be tabbable at a time
          let initialTabIndexSet = false;
          // Painting state shared across cells for current render
          const painting = {
            active: false,
            mode: 'assign', // or 'erase'
            pointerId: null,
            visited: new Set(),
            lockStudentId: null
          };
          DAYS.forEach((day, di) => {
            const block = document.createElement('div');
            block.className = 'day-block';
            // Header
            const header = document.createElement('div');
            header.className = 'day-header';
            header.textContent = day.toUpperCase();
            block.appendChild(header);
            // Legend
            const legend = document.createElement('div');
            legend.className = 'legend-row';
            const columns = Math.max(1, students.length);
            const legendChips = [];
            students.forEach((s, chipIdx) => {
              const chip = document.createElement('div');
              chip.className = `legend-chip swatch-${s.colorIndex ?? 0}`;
              chip.textContent = s.code || '?';
              chip.title = `${s.name} (${s.role || ''})`;
              chip.dataset.colIndex = String(chipIdx);
              legend.appendChild(chip);
              legendChips.push(chip);
            });
            block.appendChild(legend);
            // Rows with interactive cells
            const rows = document.createElement('div');
            rows.className = 'schedule-rows';
            for (let si = 0; si < 16; si++) {
              const row = document.createElement('div');
              row.className = 'slot-row';
              row.setAttribute('role', 'row');
              for (let c = 0; c < columns; c++) {
                const cell = document.createElement('div');
                cell.className = 'slot-cell';
                cell.setAttribute('role', 'gridcell');
                // Roving tabindex: first created cell is tabbable; others are programmatically focusable only
                if (!initialTabIndexSet) { cell.tabIndex = 0; initialTabIndexSet = true; } else { cell.tabIndex = -1; }
                const student = students[c];
                // Always annotate navigational indices for keyboard movement
                cell.dataset.dayIndex = String(di);
                cell.dataset.slotIndex = String(si);
                cell.dataset.colIndex = String(c);
                if (student) {
                  cell.dataset.studentId = student.id;
                  cell.title = `${day} ${SLOT_LABELS[si]} • ${student.name}`;
                  const k = makeKey(di, si, student.id);
                  const assigned = !!schedule[k];
                  if (assigned) {
                    cell.classList.add(`swatch-${student.colorIndex ?? 0}`);
                    cell.setAttribute('aria-pressed', 'true');
                  } else {
                    cell.setAttribute('aria-pressed', 'false');
                  }
                  cell.addEventListener('click', (e) => {
                    if (cell.dataset.skipNextClick === '1') { cell.dataset.skipNextClick = '0'; e.preventDefault(); return; }
                    if (painting && painting.active) return;
                    const wasAssigned = !!DataManager.state.schedule[k];
                    const next = !wasAssigned;
                    if (next) {
                      DataManager.state.schedule[k] = true;
                      cell.classList.add(`swatch-${student.colorIndex ?? 0}`);
                      cell.setAttribute('aria-pressed', 'true');
                    } else {
                      delete DataManager.state.schedule[k];
                      cell.classList.remove(`swatch-${student.colorIndex ?? 0}`);
                      cell.setAttribute('aria-pressed', 'false');
                    }
                    DataManager.save();
                    UI.renderTotals();
                  });

                  // Enable pointer-based paint selection
                  cell.style.touchAction = 'none';
                  const hoverOn = () => {
                    row.classList.add('is-hover');
                    cell.classList.add('col-hover');
                    const siIdx = parseInt(cell.dataset.slotIndex || '0', 10);
                    const lg = leftGutter?.children?.[siIdx + 2];
                    const rg = rightGutter?.children?.[siIdx + 2];
                    if (lg) lg.classList.add('is-hover');
                    if (rg) rg.classList.add('is-hover');
                    // Highlight matching legend chip for this column
                    const ci = parseInt(cell.dataset.colIndex || '0', 10);
                    const chip = legendChips[ci];
                    if (chip) chip.classList.add('is-hover');
                  };
                  const hoverOff = () => {
                    row.classList.remove('is-hover');
                    // Remove col-hover from all cells in this column within this day block
                    // Simpler: just remove from this cell; others will handle their own
                    cell.classList.remove('col-hover');
                    const siIdx = parseInt(cell.dataset.slotIndex || '0', 10);
                    const lg = leftGutter?.children?.[siIdx + 2];
                    const rg = rightGutter?.children?.[siIdx + 2];
                    if (lg) lg.classList.remove('is-hover');
                    if (rg) rg.classList.remove('is-hover');
                    const ci = parseInt(cell.dataset.colIndex || '0', 10);
                    const chip = legendChips[ci];
                    if (chip) chip.classList.remove('is-hover');
                  };
                  cell.addEventListener('mouseenter', hoverOn);
                  cell.addEventListener('mouseleave', hoverOff);
                  cell.addEventListener('focus', () => {
                    // BFROS edge debug: log when focusing last row or first/last column
                    const siIdx = parseInt(cell.dataset.slotIndex || '0', 10);
                    const ciIdx = parseInt(cell.dataset.colIndex || '0', 10);
                    const isBottom = siIdx === 15;
                    const isLeft = ciIdx === 0;
                    const isRight = ciIdx === (Math.max(1, (DataManager.state?.students?.length || 0)) - 1);
                    if (isBottom || isLeft || isRight) {
                      console.debug('[grid-edge-focus]', { day: di, slot: siIdx, col: ciIdx, isBottom, isLeft, isRight });
                    }
                    hoverOn();
                  });
                  cell.addEventListener('blur', hoverOff);
                  cell.addEventListener('pointerdown', (ev) => {
                    if (!cell.dataset.studentId) return;
                    const startAssigned = !!DataManager.state.schedule[k];
                    const forceErase = !!ev.altKey;
                    painting.active = true;
                    painting.mode = forceErase ? 'erase' : (startAssigned ? 'erase' : 'assign');
                    painting.pointerId = ev.pointerId;
                    painting.visited.clear();
                    painting.lockStudentId = cell.dataset.studentId;
                    try { cell.setPointerCapture(ev.pointerId); } catch (err) {}
                    root.style.userSelect = 'none';
                    // Suppress the synthetic click that follows pointerup
                    cell.dataset.skipNextClick = '1';
                    // Show indicator
                    indicator.style.display = 'block';
                    indicator.textContent = '0.00 h';
                    indicator.style.left = ev.clientX + 'px';
                    indicator.style.top = ev.clientY + 'px';

                    const applyToCell = (target) => {
                      if (!target) return;
                      const sid = target.dataset.studentId;
                      if (!sid) return;
                      // Enforce column lock: only apply to the starting student's column
                      if (painting.lockStudentId && String(sid) !== String(painting.lockStudentId)) return;
                      const ddi = parseInt(target.dataset.dayIndex || '0', 10);
                      const ssi = parseInt(target.dataset.slotIndex || '0', 10);
                      const key = makeKey(ddi, ssi, sid);
                      if (painting.visited.has(key)) return;
                      painting.visited.add(key);
                      const studentsNow = (DataManager.state?.students) || [];
                      const stu = studentsNow.find(s => String(s.id) === String(sid));
                      const colorIndex = stu?.colorIndex ?? 0;
                      const isAssigned = !!DataManager.state.schedule[key];
                      if (painting.mode === 'assign' && !isAssigned) {
                        DataManager.state.schedule[key] = true;
                        target.classList.add(`swatch-${colorIndex}`);
                        target.setAttribute('aria-pressed', 'true');
                      } else if (painting.mode === 'erase' && isAssigned) {
                        delete DataManager.state.schedule[key];
                        target.classList.remove(`swatch-${colorIndex}`);
                        target.setAttribute('aria-pressed', 'false');
                      }
                    };

                    // Apply to origin cell immediately
                    applyToCell(cell);

                    const onPointerMove = (moveEv) => {
                      if (!painting.active || moveEv.pointerId !== painting.pointerId) return;
                      const el = document.elementFromPoint(moveEv.clientX, moveEv.clientY);
                      const t = el && el.closest ? el.closest('.slot-cell') : null;
                      if (t) applyToCell(t);
                      // Update indicator position and time
                      indicator.style.left = moveEv.clientX + 'px';
                      indicator.style.top = moveEv.clientY + 'px';
                      const slots = painting.visited.size;
                      const hours = (slots * 0.5).toFixed(2);
                      indicator.textContent = `${hours} h`;
                    };
                    const onPointerEnd = (endEv) => {
                      if (endEv.pointerId !== painting.pointerId) return;
                      painting.active = false;
                      try { cell.releasePointerCapture(endEv.pointerId); } catch (err) {}
                      root.style.userSelect = '';
                      window.removeEventListener('pointermove', onPointerMove, true);
                      window.removeEventListener('pointerup', onPointerEnd, true);
                      window.removeEventListener('pointercancel', onPointerEnd, true);
                      painting.lockStudentId = null;
                      // Hide indicator
                      indicator.style.display = 'none';
                      DataManager.save();
                      UI.renderTotals();
                    };
                    window.addEventListener('pointermove', onPointerMove, true);
                    window.addEventListener('pointerup', onPointerEnd, true);
                    window.addEventListener('pointercancel', onPointerEnd, true);
                  });
                }
                // Keyboard navigation and activation
                cell.addEventListener('keydown', (e) => {
                  const key = e.key;
                  if (key === ' ' || key === 'Spacebar' || key === 'Enter') {
                    e.preventDefault();
                    // Trigger click/toggle if a student is present
                    if (cell.dataset.studentId) cell.click();
                    return;
                  }
                  let dayIndex = parseInt(cell.dataset.dayIndex || '0', 10);
                  let slotIndex = parseInt(cell.dataset.slotIndex || '0', 10);
                  let colIndex = parseInt(cell.dataset.colIndex || '0', 10);
                  const maxDay = 4; // Monday..Friday
                  const maxRow = 15; // 16 slots
                  const columnsNow = Math.max(1, (DataManager.state?.students?.length || 0));
                  let handled = true;
                  switch (key) {
                    case 'ArrowRight': colIndex = Math.min(columnsNow - 1, colIndex + 1); break;
                    case 'ArrowLeft': colIndex = Math.max(0, colIndex - 1); break;
                    case 'ArrowDown': slotIndex = Math.min(maxRow, slotIndex + 1); break;
                    case 'ArrowUp': slotIndex = Math.max(0, slotIndex - 1); break;
                    case 'Home': colIndex = 0; break;
                    case 'End': colIndex = columnsNow - 1; break;
                    case 'PageDown': dayIndex = Math.min(maxDay, dayIndex + 1); break;
                    case 'PageUp': dayIndex = Math.max(0, dayIndex - 1); break;
                    default: handled = false;
                  }
                  if (!handled) return;
                  e.preventDefault();
                  const selector = `#weekGrid .day-block:nth-child(${dayIndex + 1}) .schedule-rows .slot-row:nth-child(${slotIndex + 1}) .slot-cell:nth-child(${colIndex + 1})`;
                  const target = document.querySelector(selector);
                  if (target) {
                    const current = document.querySelector('#weekGrid .slot-cell[tabindex="0"]');
                    if (current && current !== target) { current.tabIndex = -1; }
                    target.tabIndex = 0;
                    target.focus();
                  }
                });
                row.appendChild(cell);
              }
              rows.appendChild(row);
            }
            block.appendChild(rows);
            root.appendChild(block);
          });

        },
        openStudentModal() {
          document.getElementById('studentName').value = '';
          document.getElementById('studentRole').value = 'PA';
          document.getElementById('studentModal').style.display = 'flex';
          setTimeout(() => document.getElementById('studentName').focus(), 0);
        },
        closeStudentModal() {
          document.getElementById('studentModal').style.display = 'none';
        }
      };


      // Public API placeholders (to be implemented in next milestones)
      window.saveSchedule = function saveSchedule() {
        DataManager.save();
        UI.renderTotals();
        alert('Saved current state locally. Export to persist into a file.');
      };

      window.clearTimes = function clearTimes() {
        if (!confirm('Clear all scheduled times? Students remain intact.')) return;
        if (!DataManager.state) return;
        DataManager.state.schedule = {};
        DataManager.save();
        UI.renderWeek(DataManager.state.students || []);
        UI.renderTotals();
        alert('All times cleared.');
      };

      window.exportToPDF = async function exportToPDF() {
        try {
          const { jsPDF } = window.jspdf || {};
          if (!jsPDF || typeof html2canvas === 'undefined') {
            alert('PDF libraries not loaded yet.');
            return;
          }

          const margin = 24; // pt
          const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
          const pageWidth = doc.internal.pageSize.getWidth();
          const pageHeight = doc.internal.pageSize.getHeight();

          // Page 1: capture schedule grid
          const grid = document.getElementById('weekGrid');
          let canvas;
          try {
            canvas = await html2canvas(grid, {
              scale: 2,
              windowWidth: grid.scrollWidth,
              windowHeight: grid.scrollHeight
            });
          } catch (e1) {
            // Fallback scale for memory-constrained environments
            canvas = await html2canvas(grid, {
              scale: 1.5,
              windowWidth: grid.scrollWidth,
              windowHeight: grid.scrollHeight
            });
          }
          const imgData = canvas.toDataURL('image/png');
          const availableW = pageWidth - margin * 2;
          const availableH = pageHeight - margin * 2;
          const ratio = Math.min(availableW / canvas.width, availableH / canvas.height);
          const targetW = canvas.width * ratio;
          const targetH = canvas.height * ratio;
          const targetX = (pageWidth - targetW) / 2;
          const targetY = (pageHeight - targetH) / 2;

          // Optional header on page 1
          const title = (window.__DataManager?.state?.settings?.headerTitle) || 'STUDENT WORKER SCHEDULE | 2024–2025';
          const dateStr = new Date().toLocaleDateString();
          doc.setFontSize(12);
          doc.text(title, margin, 20);
          doc.text(dateStr, pageWidth / 2, 20, { align: 'center' });

          doc.addImage(imgData, 'PNG', targetX, targetY, targetW, targetH);

          // Page 2: totals via AutoTable
          doc.addPage('letter', 'landscape');

          // Build totals data from DataManager.state
          const head = ['Student','Mon','Tue','Wed','Thu','Fri','Total'];
          const { perStudent, dailyTotals, grand } = DataManager.computeTotals(window.__DataManager?.state);
          const body = perStudent.map(r => [r.name, ...r.days.map(d=>d.toFixed(2)), r.total.toFixed(2)]);
          const totalsRow = ['DAILY TOTALS', ...dailyTotals.map(d=>d.toFixed(2)), grand.toFixed(2)];

          // Optional parity check against UI totals table
          try {
            const tbodyEl = document.querySelector('#totalsTable tbody');
            if (tbodyEl) {
              let mismatchCount = 0;
              const rows = Array.from(tbodyEl.querySelectorAll('tr'));
              const domTotalsRow = rows.find(r => (r.querySelector('td')?.textContent || '').trim().toUpperCase() === 'DAILY TOTALS');
              const domStudentRows = rows.filter(r => r !== domTotalsRow);
              const domMap = new Map();
              domStudentRows.forEach(r => {
                const tds = Array.from(r.querySelectorAll('td'));
                if (tds.length === 7) {
                  const name = (tds[0].textContent || '').trim();
                  const vals = tds.slice(1).map(td => (td.textContent || '').trim());
                  domMap.set(name, vals);
                }
              });
              // Compare per-student rows to UI
              body.forEach(row => {
                const name = row[0];
                const vals = row.slice(1);
                const domVals = domMap.get(name);
                if (!domVals) { mismatchCount++; return; }
                for (let i = 0; i < vals.length; i++) {
                  if (String(vals[i]) !== String(domVals[i])) { mismatchCount++; break; }
                }
              });
              // Compare totals row to UI
              if (domTotalsRow) {
                const tds = Array.from(domTotalsRow.querySelectorAll('td'));
                const domTotalsVals = tds.slice(1).map(td => (td.textContent || '').trim());
                const pdfTotalsVals = totalsRow.slice(1);
                for (let i = 0; i < pdfTotalsVals.length; i++) {
                  if (String(pdfTotalsVals[i]) !== String(domTotalsVals[i])) { mismatchCount++; break; }
                }
              }
              if (mismatchCount > 0) {
                console.warn('PDF/UI totals parity check: mismatches detected =', mismatchCount);
              }
            }
          } catch (parityErr) {
            console.warn('PDF/UI totals parity check skipped:', parityErr);
          }

          // Render table using AutoTable
          if (typeof doc.autoTable !== 'function') {
            alert('AutoTable plugin not available.');
            doc.save('student_schedule_preview.pdf');
            return;
          }

          doc.autoTable({
            head: [head],
            body,
            theme: 'grid',
            styles: { fontSize: 10, cellPadding: 4 },
            headStyles: { fillColor: [234,227,217], textColor: 0 },
            columnStyles: {
              0: { halign: 'left', cellWidth: 160 },
              1: { halign: 'right' },
              2: { halign: 'right' },
              3: { halign: 'right' },
              4: { halign: 'right' },
              5: { halign: 'right' },
              6: { halign: 'right' }
            },
            margin: { top: 36, right: margin, bottom: margin, left: margin },
            foot: [totalsRow],
            footStyles: { fontStyle: 'bold' },
            showHead: 'everyPage',
            showFoot: 'lastPage',
            pageBreak: 'auto',
            didDrawPage: (data) => {
              // Header and footer for table pages
              doc.setFontSize(12);
              doc.text(title, data.settings.margin.left, 20);
              doc.text(dateStr, pageWidth / 2, 20, { align: 'center' });
              const pageStr = 'Page ' + (data.pageNumber || 1);
              doc.text(pageStr, pageWidth - data.settings.margin.right, pageHeight - 12, { align: 'right' });
            }
          });

          // Footer page number for page 1 as well
          doc.setPage(1);
          doc.setFontSize(12);
          doc.text('Page 1', pageWidth - margin, pageHeight - 12, { align: 'right' });

          doc.save('student_schedule_preview.pdf');
        } catch (err) {
          console.error(err);
          alert('PDF export failed: ' + (err && err.message ? err.message : 'Unknown error'));
        }
      };

      window.exportSchedule = function exportSchedule() {
        // Placeholder: basic single-file export with embedded JSON replaced
        if (!DataManager.state) return;
        const serializer = new XMLSerializer();
        const cloneDoc = document.cloneNode(true);
        const embedded = cloneDoc.getElementById('embedded-data');
        if (embedded) {
          embedded.textContent = JSON.stringify({
            version: DataManager.state.version || APP_VERSION,
            metadata: { ...DataManager.state.metadata, exportedAt: new Date().toISOString(), source: 'export' },
            settings: DataManager.state.settings,
            students: DataManager.state.students,
            schedule: DataManager.state.schedule
          });
        }
        const html = '<!DOCTYPE html>\n' + serializer.serializeToString(cloneDoc);
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const a = document.createElement('a');
        const dateStr = new Date().toISOString().slice(0,10);
        a.download = `student_schedule_${dateStr}.html`;
        a.href = URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
      };

      // --- MiniTest harness ---
      (function initTests(){
        const log = (...args) => {
          const el = document.getElementById('testResults');
          if (!el) return;
          el.textContent += args.join(' ') + '\n';
        };
        const clearLog = () => {
          const el = document.getElementById('testResults');
          if (el) el.textContent = '';
        };

        function assertEqual(actual, expected, msg) {
          if (String(actual) !== String(expected)) throw new Error(`${msg} (got=${actual}, expected=${expected})`);
        }

        async function testTotalsEmpty() {
          const state = { students: [], schedule: {} };
          const { perStudent, dailyTotals, grand } = DataManager.computeTotals(state);
          assertEqual(perStudent.length, 0, 'No students when empty');
          assertEqual(dailyTotals.join(','), '0,0,0,0,0', 'Daily totals zeros');
          assertEqual(grand, 0, 'Grand total zero');
        }

        async function testTotalsSynthetic() {
          const s1 = { id: 'a', name: 'A', role: 'PA' };
          const s2 = { id: 'b', name: 'B', role: 'WS' };
          const schedule = {};
          // A: Monday first two slots, Tuesday one slot → 1.5h + 0.5h = 2.0h
          schedule[`0|0|${s1.id}`] = true;
          schedule[`0|1|${s1.id}`] = true;
          schedule[`1|0|${s1.id}`] = true;
          // B: Friday four slots → 2.0h
          schedule[`4|0|${s2.id}`] = true;
          schedule[`4|1|${s2.id}`] = true;
          schedule[`4|2|${s2.id}`] = true;
          schedule[`4|3|${s2.id}`] = true;
          const { perStudent, dailyTotals, grand } = DataManager.computeTotals({ students:[s1,s2], schedule });
          // A row
          const rowA = perStudent[0];
          assertEqual(rowA.total.toFixed(2), '1.50', 'A weekly total 1.50h');
          assertEqual(rowA.days[0].toFixed(2), '1.00', 'A Mon 1.00h');
          assertEqual(rowA.days[1].toFixed(2), '0.50', 'A Tue 0.50h');
          // B row
          const rowB = perStudent[1];
          assertEqual(rowB.total.toFixed(2), '2.00', 'B weekly total 2.00h');
          assertEqual(rowB.days[4].toFixed(2), '2.00', 'B Fri 2.00h');
          // Totals
          assertEqual(dailyTotals[0].toFixed(2), '1.00', 'Mon total 1.00h');
          assertEqual(dailyTotals[4].toFixed(2), '2.00', 'Fri total 2.00h');
          assertEqual(grand.toFixed(2), '3.50', 'Grand total 3.50h');
        }

        async function testSaveLoadRoundTrip() {
          const prev = JSON.parse(JSON.stringify(DataManager.state));
          // mutate
          DataManager.state.students = [{ id:'x', name:'X', role:'PA', code:'X', colorIndex:0 }];
          DataManager.state.schedule = { '0|0|x': true };
          DataManager.save();
          const cache = JSON.parse(localStorage.getItem('studentScheduleAppState'));
          if (!cache) throw new Error('No cached appState after save');
          const loaded = DataManager.load();
          assertEqual(!!loaded, true, 'Loaded state');
          // restore
          DataManager.state = prev;
          DataManager.save();
        }

        async function testExportImportRoundTrip() {
          // Serialize clone and parse back embedded data
          const serializer = new XMLSerializer();
          const cloneDoc = document.cloneNode(true);
          const embedded = cloneDoc.getElementById('embedded-data');
          if (!embedded) throw new Error('No embedded-data element');
          // replace with current state
          embedded.textContent = JSON.stringify({
            version: DataManager.state.version,
            metadata: { ...DataManager.state.metadata, exportedAt: new Date().toISOString(), source: 'test' },
            settings: DataManager.state.settings,
            students: DataManager.state.students,
            schedule: DataManager.state.schedule
          });
          const html = '<!DOCTYPE html>\n' + serializer.serializeToString(cloneDoc);
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const back = doc.getElementById('embedded-data');
          const imported = JSON.parse(back.textContent || '{}');
          assertEqual(JSON.stringify(imported.students).length > 0, true, 'Imported students present');
          assertEqual(typeof imported.schedule, 'object', 'Imported schedule object');
        }

        window.__Tests = {
          async runAll() {
            clearLog();
            const start = performance.now();
            let passed = 0, failed = 0;
            const tests = [
              ['Totals empty', testTotalsEmpty],
              ['Totals synthetic', testTotalsSynthetic],
              ['Save/Load round-trip', testSaveLoadRoundTrip],
              ['Export/Import round-trip', testExportImportRoundTrip]
            ];
            for (const [name, fn] of tests) {
              try { await fn(); log(`✅ ${name}`); passed++; }
              catch (e) { log(`❌ ${name}: ${e.message}`); failed++; }
            }
            const ms = Math.round(performance.now() - start);
            log(`\nDone. Passed=${passed} Failed=${failed} (${ms} ms)`);
          }
        };
      })();

      // Import removed per requirements (no file input or import flow)

      window.addStudentFromModal = function addStudentFromModal() {
        const name = document.getElementById('studentName').value.trim();
        const role = document.getElementById('studentRole').value;
        if (!name) { alert('Please enter a name.'); return; }
        const code = name.split(/\s+/).map(s => s[0]).join('').slice(0,3).toUpperCase();
        const colorIndex = (DataManager.state.students.length) % 5;
        const id = 'stu-' + (Date.now());
        DataManager.state.students.push({ id, name, code, role, colorIndex });
        DataManager.save();
        // Re-render grid and totals with new student
        UI.renderWeek(DataManager.state.students);
        UI.renderTotals();
        // Close modal
        document.getElementById('studentModal').style.display = 'none';
      };

      // Boot
      DataManager.load();
      UI.init();
      // Expose minimal objects only if needed later
      window.__DataManager = DataManager;
      window.__UI = UI;
    })();
  </script>
</body>
</html>


